name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  format-check:
    name: Check code formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install clang-format-18
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-18

      - name: Check C++ formatting
        run: ./scripts/format.sh --check

  tidy-check:
    name: Run clang-tidy checks
    runs-on: ubuntu-latest
    container: fedora:42
    needs: [format-check]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          dnf install -y \
            gcc-c++ \
            clang \
            clang-tools-extra \
            cmake \
            ninja-build \
            git \
            protobuf-devel \
            abseil-cpp-devel \
            paho-c-devel \
            openssl-devel

      - name: Configure CMake
        env:
          CC: clang
          CXX: clang++
        run: cmake --preset default

      - name: Build (for compile_commands.json)
        run: cmake --build build -j$(nproc)

      - name: Run clang-tidy
        run: ./scripts/tidy.sh --quiet

  build-ubuntu-dynamic:
    name: Build Ubuntu 24.04 (dynamic)
    runs-on: ubuntu-24.04
    needs: [tidy-check]
    strategy:
      matrix:
        library: [c, cpp]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang-18 \
            cmake \
            git \
            protobuf-compiler \
            libprotobuf-dev \
            libabsl-dev \
            libssl-dev \
            pkg-config

      - name: Build and install Paho MQTT C
        run: |
          cd /tmp
          git clone --depth 1 --branch v1.3.15 https://github.com/eclipse/paho.mqtt.c.git
          cd paho.mqtt.c
          cmake -Bbuild \
            -DCMAKE_BUILD_TYPE=Release \
            -DPAHO_WITH_SSL=ON \
            -DPAHO_BUILD_DOCUMENTATION=OFF \
            -DPAHO_BUILD_SAMPLES=OFF \
            -DPAHO_BUILD_STATIC=OFF
          cmake --build build -j$(nproc)
          sudo cmake --install build

      - name: Build ${{ matrix.library }} library
        env:
          CC: clang-18
          CXX: clang++-18
        run: |
          cmake -S . -B build-release \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=ON
          cmake --build build-release -j$(nproc) --target sparkplug_${{ matrix.library }}

      - name: Create package
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          PACKAGE_NAME="sparkplug-${{ matrix.library }}-${VERSION}-ubuntu24.04-x86_64"
          mkdir -p ${PACKAGE_NAME}/{lib,include}

          # Copy library
          cp build-release/src/libsparkplug_${{ matrix.library }}.so* ${PACKAGE_NAME}/lib/

          # Copy headers
          if [ "${{ matrix.library }}" = "c" ]; then
            mkdir -p ${PACKAGE_NAME}/include/sparkplug
            cp include/sparkplug/sparkplug_c.h ${PACKAGE_NAME}/include/sparkplug/
          else
            cp -r include/sparkplug ${PACKAGE_NAME}/include/
          fi

          # Create README
          cat > ${PACKAGE_NAME}/README.md << 'EOF'
          # Sparkplug B ${{ matrix.library }} Library (Ubuntu 24.04)

          Dynamic library build for Ubuntu 24.04 LTS.

          ## Dependencies

          Install runtime dependencies:
          ```bash
          sudo apt-get install libprotobuf33 libabsl20230802 libpaho-mqtt-c1.3 libssl3
          ```

          ## Installation

          ```bash
          sudo cp lib/* /usr/local/lib/
          sudo cp -r include/* /usr/local/include/
          sudo ldconfig
          ```
          EOF

          # Create tarball
          tar czf ${PACKAGE_NAME}.tar.gz ${PACKAGE_NAME}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-${{ matrix.library }}
          path: '*.tar.gz'

  build-alpine-static:
    name: Build Alpine Linux (static musl)
    runs-on: ubuntu-latest
    container: alpine:latest
    needs: [tidy-check]
    steps:
      - name: Install build dependencies
        run: |
          apk add --no-cache \
            build-base \
            cmake \
            git \
            bash \
            linux-headers \
            openssl-dev \
            openssl-libs-static \
            zlib-static \
            samurai \
            protobuf-dev \
            protoc

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build static musl bundle
        run: |
          export VERSION="${GITHUB_REF_NAME#v}"
          bash ./scripts/build_static_musl.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: alpine-static-c
          path: 'build-static-musl/*.tar.gz'

  build-fedora-dynamic:
    name: Build Fedora 42 (dynamic)
    runs-on: ubuntu-latest
    container: fedora:42
    needs: [tidy-check]
    strategy:
      matrix:
        library: [c, cpp]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          dnf install -y \
            gcc-c++ \
            clang \
            cmake \
            ninja-build \
            git \
            protobuf-devel \
            abseil-cpp-devel \
            paho-c-devel \
            openssl-devel

      - name: Build ${{ matrix.library }} library
        env:
          CC: clang
          CXX: clang++
        run: |
          cmake -S . -B build-release \
            -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=ON
          cmake --build build-release -j$(nproc) --target sparkplug_${{ matrix.library }}

      - name: Create package
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          PACKAGE_NAME="sparkplug-${{ matrix.library }}-${VERSION}-fedora42-x86_64"
          mkdir -p ${PACKAGE_NAME}/{lib,include}

          cp build-release/src/libsparkplug_${{ matrix.library }}.so* ${PACKAGE_NAME}/lib/

          if [ "${{ matrix.library }}" = "c" ]; then
            mkdir -p ${PACKAGE_NAME}/include/sparkplug
            cp include/sparkplug/sparkplug_c.h ${PACKAGE_NAME}/include/sparkplug/
          else
            cp -r include/sparkplug ${PACKAGE_NAME}/include/
          fi

          cat > ${PACKAGE_NAME}/README.md << 'EOF'
          # Sparkplug B ${{ matrix.library }} Library (Fedora 42)

          Dynamic library build for Fedora 42+.

          ## Dependencies

          ```bash
          sudo dnf install protobuf abseil-cpp paho-c openssl
          ```

          ## Installation

          ```bash
          sudo cp lib/* /usr/local/lib64/
          sudo cp -r include/* /usr/local/include/
          sudo ldconfig
          ```
          EOF

          tar czf ${PACKAGE_NAME}.tar.gz ${PACKAGE_NAME}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fedora-${{ matrix.library }}
          path: '*.tar.gz'

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-ubuntu-dynamic, build-alpine-static, build-fedora-dynamic]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -name '*.tar.gz' -exec cp {} release-assets/ \;
          ls -lh release-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: release-assets/*.tar.gz
